easyblock = 'PythonBundle'

name = 'QIIME2'
version = '2020.8.0'
versionsuffix = '-Python-%(pyver)s'

homepage = 'https://qiime2.org'
description = """QIIME 2 is a powerful, extensible, and decentralized microbiome bioinformatics platform that is free,
open source, and community developed."""

toolchain = {'name': 'foss', 'version': '2020a'}

dependencies = [
    ('Python', '3.8.2'),
    ('SciPy-bundle', '2020.03', versionsuffix),
    ('matplotlib', '3.2.1', versionsuffix),
    ('PyYAML', '5.3'),
    ('Java', '11', '', True),
    ('Perl', '5.30.2'),
    ('R', '4.0.0'),
    ('R-bundle-Bioconductor', '3.11', '-R-%(rver)s'),
    ('alsa-lib', '1.2.4'),
    ('BLAST+', '2.10.1'),
    ('bokeh', '2.0.2', versionsuffix),
    ('Boost', '1.72.0'),
    ('Bowtie2', '2.4.1'),
    ('bwidget', '1.9.14'),
    ('bzip2', '1.0.8'),
    ('cairo', '1.16.0'),
    ('cURL', '7.69.1'),
    ('cutadapt', '2.10', versionsuffix),
    ('DendroPy', '4.4.0'),
    ('expat', '2.2.9'),
    ('FastTree', '2.1.11'),
    ('fontconfig', '2.13.92'),
    ('freetype', '2.10.1'),
    ('FriBidi', '1.0.9'),
    ('giflib', '5.2.1'),
    ('GLib', '2.64.1'),
    ('GSL', '2.6'),
    ('h5py', '2.10.0', versionsuffix),
    ('HarfBuzz', '2.6.4'),
    ('scikit-bio', '0.5.6', versionsuffix),
    ('Seaborn', '0.10.1', versionsuffix),
    ('statsmodels', '0.11.1', versionsuffix),
    # skipped dependencies, trouble to get these installed
    # ('ARB', '6.0.6'),
]

use_pip = True

# avoid that hidden (sub)directories like .config/q2cli are created in home directory
preinstallopts = "export HOME=%(builddir)s/home && "

exts_default_options = {'source_urls': [PYPI_SOURCE]}

exts_list = [
    ('tzlocal', '2.1', {
        'checksums': ['643c97c5294aedc737780a49d9df30889321cbe1204eac2c2ec6134035a92e44'],
    }),
    ('flit_core', '3.0.0', {
        'checksums': ['a465052057e2d6d957e6850e9915245adedfc4fd0dd5737d0791bf3132417c2d'],
    }),
    ('pytoml', '0.1.21', {
        'checksums': ['8eecf7c8d0adcff3b375b09fe403407aa9b645c499e5ab8cac670ac4a35f61e7'],
    }),
    ('backcall', '0.2.0', {
        'checksums': ['5cbdbf27be5e7cfadb448baf0aa95508f91f2bbc6c6437cd9cd06e2a4c215e1e'],
    }),
    ('backports.functools_lru_cache', '1.6.1', {
        'checksums': ['8fde5f188da2d593bd5bc0be98d9abc46c95bb8a9dde93429570192ee6cc2d4a'],
    }),
    ('argon2-cffi', '20.1.0', {
        'modulename': 'argon2',
        'checksums': ['d8029b2d3e4b4cea770e9e5a0104dd8fa185c1724a0f01528ae4826a6d25f97d'],
    }),
    ('biom-format', '2.1.9', {
        'checksums': ['18a6e4d4b4b2a6bf2d5544fa357ad168bedeac93f0837015ef9c72f41fa89491'],
        'modulename': 'biom',
    }),
    ('webencodings', '0.5.1', {
        'checksums': ['b36a1c245f2d304965eb4e0a82848379241dc04b865afcc4aab16748587e1923'],
    }),
    ('bleach', '3.2.1', {
        'checksums': ['52b5919b81842b1854196eaae5ca29679a2f2e378905c346d3ca8227c2c66080'],
    }),
    ('brotlipy', '0.7.0', {
        'checksums': ['36def0b859beaf21910157b4c33eb3b06d8ce459c942102f16988cca6ea164df'],
        'modulename': 'brotli',
    }),
    ('bibtexparser', '1.2.0', {
        'checksums': ['0f9ab94e3fc36ee2ee6a3713c5dd7320d4b6ee52bd66ecbab03c6b06675ae410'],
    }),
    ('msgpack', '1.0.0', {
        'checksums': ['9534d5cc480d4aff720233411a1f765be90885750b07df772380b34c10ecb5c0'],
    }),
    ('CacheControl', '0.12.6', {
        'checksums': ['be9aa45477a134aee56c8fac518627e1154df063e85f67d4f83ce0ccc23688e8'],
    }),
    ('deblur', '1.1.0', {
        'checksums': ['78ca2c9946ed99c0d49352e92b63083ae10d04734af7682baddb2c31966c1674'],
    }),
    ('defusedxml', '0.6.0', {
        'checksums': ['f684034d135af4c6cbb949b8a4d2ed61634515257a67299e5f940fbaa34377f5'],
    }),
    ('dnaio', '0.4.3', {
        'checksums': ['b73d4b11778c7aae62004942636f3aecbb2d9b569c4696bfef42d64fd31baf24'],
    }),
    ('easy_entrez', '0.2.2', {
        'checksums': ['e1be7c8f1df430c593d1c77c0e0c32896730981d0ea0dd507154f5614ee7cbeb'],
        # strip out dataclasses required, not compatible/required with Python 3.8
        'preinstallopts': """sed -i "s@, 'dataclasses'@@g" setup.py && """,
    }),
    ('emperor', '1.0.1', {
        'checksums': ['e4d30501d079bfe50c3e015f83ac741d60474296859b470d500cfcd8a2571fc7'],
    }),
    ('fastcluster', '1.1.26', {
        'checksums': ['a202f44a3b06f5cf9cdba3c67d6c523288922d6e6a1cdf737292f93759aa82f7'],
    }),
    ('gneiss', '0.4.6', {
        'checksums': ['5ebf32148909cf74475e45682042c68224f002c1cbf723a5c96014a30f1cf323'],
    }),
    ('hdmedians', '0.14.1', {
        'checksums': ['ccefaae26302afd843c941b3b662f1119d5a36dec118077310f811a7a1ed8871'],
    }),
    ('ijson', '3.1.2.post0', {
        'source_urls': ['https://github.com/ICRAR/ijson/archive/'],
        'sources': [{'download_filename': 'v%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['4440b8cff2ded9788b60e6d56da7ae2ca70424abc3f39f6d97e6239c90176cdf'],
    }),
    ('unifrac', '0.10.0', {
        'checksums': ['94b4a1b146b35ee7f855ae602cedfab2ca179cc87e397d535fd3e7f64d4d7349'],
        'preinstallopts': "export PREFIX=%(installdir)s && export LIBRARY_PATH=%(installdir)s/lib:$LIBRARY_PATH && ",
    }),
    (name, version, {
        'source_urls': ['https://github.com/qiime2/qiime2/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['a752b8d1eefd0deb936bdb44637488d34a06ef2a59beecd848b8c8d4ec034d7b'],
    }),
    ('q2cli', version, {
        'source_urls': ['https://github.com/qiime2/q2cli/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['044d89a7fd9c0fb65f42f5b5b48d8a4f750c1c683f9c8f00427115bd9a405682'],
    }),
    ('q2-alignment', version, {
        'source_urls': ['https://github.com/qiime2/q2-alignment/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['e74d30df9abda0604f265b77430870e2b381017fa4e1c7560494d9088d4d2bfd'],
    }),
    ('q2-composition', version, {
        'source_urls': ['https://github.com/qiime2/q2-composition/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['1c6c03a68be48ce9c27b067e6b1a9968bab63ae7a646985c0bbf5bb83c577924'],
    }),
    ('q2-cutadapt', version, {
        'source_urls': ['https://github.com/qiime2/q2-cutadapt/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['576c8d159c3eefb8d6f195f776229c6521d066a5eba9cc1a20f1b8207f3e6a31'],
    }),
    ('q2-dada2', version, {
        'source_urls': ['https://github.com/qiime2/q2-dada2/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['6d9305f5b7f6d57f1025ad5b11da66fe748da30e207aa6c40d6b23df7c5e42ac'],
    }),
    ('q2-deblur', version, {
        'source_urls': ['https://github.com/qiime2/q2-deblur/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['3d74797049180fe38f2ef857a103218e37f2ef0c0d1d0a6b2c87cd108b9e63f6'],
    }),
    ('q2-demux', version, {
        'source_urls': ['https://github.com/qiime2/q2-demux/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['dd6af0e829b5dfeab34fc3e7cf39ccdc9281a8a4a08b7638686f0248dc9fd728'],
    }),
    ('q2-diversity', version, {
        'source_urls': ['https://github.com/qiime2/q2-diversity/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['5ca4856adae2ef4065246a9e6797a4eff701a7b78f60ce8b71b62222a930f1aa'],
    }),
    ('q2-diversity-lib', version, {
        'source_urls': ['https://github.com/qiime2/q2-diversity-lib/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['548c733435a0f2ca81c8a76527c19ecf3bfa25cb7e56213d929a5058cb7c3f9d'],
    }),
    ('q2-emperor', version, {
        'source_urls': ['https://github.com/qiime2/q2-emperor/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['eea3806b0a29b97282628a3efe5ba68f69a0f8d10926c904b563a777910394e9'],
    }),
    ('q2-feature-classifier', version, {
        'source_urls': ['https://github.com/qiime2/q2-feature-classifier/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['4c0662124f341b033dd76905fcc4d55632b3628404280542028a3d63bd1cb5a4'],
    }),
    ('q2-feature-table', version, {
        'source_urls': ['https://github.com/qiime2/q2-feature-table/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['4eecb3bb865dcb9445a2d4f644e3f8de64e5cf2b468f746658e22d7b644173ce'],
    }),
    ('q2-fragment-insertion', version, {
        'source_urls': ['https://github.com/qiime2/q2-fragment-insertion/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['5340e5a721e5a42c2fe399685aabacd0c6473e16fd8afaf457f7b6eee660fbe3'],
    }),
    ('q2-gneiss', version, {
        'source_urls': ['https://github.com/qiime2/q2-gneiss/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['99c716070afcde90dc14575c4721ee4cf4ef11d225b0c18bbacc95424b01c21e'],
    }),
    ('q2-longitudinal', version, {
        'source_urls': ['https://github.com/qiime2/q2-longitudinal/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['1fa648907f8d790f90806ec904b6777766b3c3c4b31ab0146cfc2b7ffd09c604'],
    }),
    ('q2-metadata', version, {
        'source_urls': ['https://github.com/qiime2/q2-metadata/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['f4c5b566fb87df74a538c6642c7b119898e5a5885c0ab189c0c29ed6a1c9cb1c'],
    }),
    ('q2-phylogeny', version, {
        'source_urls': ['https://github.com/qiime2/q2-phylogeny/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['1099cfef6decabf08a6f5d16baf2c01bedfbf9cce930ef545c97475cb0305734'],
    }),
    ('q2-quality-control', version, {
        'source_urls': ['https://github.com/qiime2/q2-quality-control/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['3757f92bcb1c41faf2cbd091c3bc9fb7e9f3e5bdd761136501c6e91679b69114'],
    }),
    ('q2-quality-filter', version, {
        'source_urls': ['https://github.com/qiime2/q2-quality-filter/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['2e6edb5fcc4e639621df95030e13b4460ea2cb83ee7fb5ba70ef691e3c06a957'],
    }),
    ('q2-sample-classifier', version, {
        'source_urls': ['https://github.com/qiime2/q2-sample-classifier/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['8903afdd93b23a84e2e0c12b226ea493c3a0539177dfd134b019f59804d61053'],
    }),
    ('q2-taxa', version, {
        'source_urls': ['https://github.com/qiime2/q2-taxa/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['126ebd88426a214047bac26c49014b822e044832cd9f59469f73f233a194b0af'],
    }),
    ('q2-types', version, {
        'source_urls': ['https://github.com/qiime2/q2-types/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['c6fd95799bfd1d188d39a732eba3d394e738d535b05c69cffd29d9a987502992'],
    }),
    ('q2-vsearch', version, {
        'source_urls': ['https://github.com/qiime2/q2-vsearch/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['733cb79ae5174d5cc61460ed96fc2293c84cf3bf79413633f140859e3e31bfaf'],
    }),
    ('q2templates', version, {
        'source_urls': ['https://github.com/qiime2/q2templates/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['073e39c1df2a0e95f7a6d2e7dc91e3c5bbdcf552808d440a5d82bb92c8f6b739'],
    }),
]

sanity_pip_check = True

sanity_check_paths = {
    'files': ['bin/biom', 'bin/qiime', 'bin/ssu', 'lib/libssu.%s' % SHLIB_EXT],
    'dirs': ['lib/python%(pyshortver)s/site-packages'],
}

sanity_check_commands = [
    "qiime --help",
    "qiime info",
]

moduleclass = 'bio'
