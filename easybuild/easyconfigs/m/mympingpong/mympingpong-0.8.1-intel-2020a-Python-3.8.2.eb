easyblock = 'PythonBundle'

name = 'mympingpong'
version = '0.8.1'
versionsuffix = '-Python-%(pyver)s'

homepage = 'https://github.com/hpcugent/mympingpong'
description = """A mpi4py based random pair pingpong network stress test."""

toolchain = {'name': 'intel', 'version': '2020a'}

dependencies = [
    ('Python', '3.8.2'),
    ('vsc-mympirun', '5.2.5', '', True),
    ('matplotlib', '3.2.1', versionsuffix),
    ('h5py', '2.10.0', versionsuffix),
    ('mpi4py', '3.0.3', versionsuffix + '-timed-pingpong'),
    ('lxml', '4.5.2'),
    ('hwloc', '2.2.0'),
]

# vsc-* packages can't be installed with pip,
# since it breaks the vsc.* namespace (see https://github.com/hpcugent/vsc-install/issues/68)
use_pip = False

exts_default_options = {'source_urls': [PYPI_SOURCE]}

exts_list = [
    ('setuptools', '41.6.0', {
        'source_tmpl': 'setuptools-%(version)s.zip',
        'checksums': ['6afa61b391dcd16cb8890ec9f66cc4015a8a31a6e1c2b4e0c464514be1a3d722'],
    }),
    (name, version, {
        'modulename': 'vsc.mympingpong',
        'checksums': ['118605f8d458c5de289af5a80dcb69904907f638e3b3635b5dec056a6a650b1b'],
    }),
]

sanity_check_paths = {
    'files': ['bin/mympingpong', 'bin/mympingponganalysis'],
    'dirs': ['lib/python%(pyshortver)s/site-packages'],
}

sanity_check_commands = [
    "mympirun --hybrid 1 mympingpong --help",
    "mympirun --hybrid 2 mympingpong -f %(builddir)s",
]

# turn off the dynamic connection establishment, to make Intel MPI create all connections up front
modextravars = {'I_MPI_DYNAMIC_CONNECTION': '0'}

moduleclass = 'perf'
